<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ôn tập Giữa kì I - Toán 8</title>

<!-- MathJax -->
<script>
window.MathJax = {
  tex: { inlineMath: [['$','$'], ['\\(','\\)']], displayMath: [['$$','$$'], ['\\[','\\]']]},
  svg: { fontCache: 'global' }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>

<style>
  :root{
    --brand:#2563eb; --ok:#16a34a; --bad:#dc2626; --warn:#d97706;
    --card:#fff; --bg:#f7f8fc; --text:#111827; --muted:#6b7280; --border:#e5e7eb;
  }
  @media (prefers-color-scheme: dark){
    :root{ --brand:#7aa2ff; --ok:#7bd68c; --bad:#ff7a7a; --warn:#ffcc7a;
           --card:#0f1622; --bg:#0b0f14; --text:#e5e7eb; --muted:#9aa4b2; --border:#202733;}
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin:0; background:var(--bg); color:var(--text); line-height:1.6}
  header{padding:18px 12px; text-align:center; background:var(--card); border-bottom:1px solid var(--border); position:sticky; top:0; z-index:10}
  h1{margin:0; color:var(--brand); font-size:clamp(20px,3.4vw,30px)}
  .small{color:var(--muted); font-size:13px}
  main{max-width:1000px; margin:14px auto 90px; padding:0 14px}
  h2{color:var(--brand); text-align:center; margin:20px 0 12px}
  .question{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; margin:12px 0}
  .qtitle{font-weight:700; margin-bottom:8px}
  .qimg{margin:8px 0 10px; text-align:center}
  .qimg img{max-width:100%; height:auto; border-radius:8px; border:1px solid var(--border)}
  .options{margin-top:6px}
  .options label{display:flex; gap:10px; align-items:center; padding:12px; margin:6px 0; border-radius:10px; cursor:pointer}
  .options input{width:20px; height:20px; transform:scale(1.1); accent-color:var(--brand)}
  .meta{color:var(--muted); font-size:13px}
  .actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin:22px 0}
  button{padding:10px 14px; border-radius:10px; border:1px solid var(--border); background:var(--card); color:var(--text); cursor:pointer; font-weight:700; min-width:140px}
  button.primary{background:var(--brand); border-color:var(--brand); color:#fff}
  button.hint-btn{background:#dff5ff; color:#0b3d60; border:1px solid #bfe9ff}
  button:focus-visible{outline:3px solid var(--brand); outline-offset:2px}
  .result{padding:8px 10px; border:1px dashed var(--border); border-radius:10px; margin-top:8px; display:none; color:var(--muted)}
  .correct{background:color-mix(in oklab, var(--ok) 18%, var(--card)); border-color:color-mix(in oklab, var(--ok) 40%, var(--border)); color:#0b4c1d}
  .incorrect{background:color-mix(in oklab, var(--bad) 14%, var(--card)); border-color:color-mix(in oklab, var(--bad) 40%, var(--border)); color:#5f1111}
  .mark-correct{outline:2px solid var(--ok); background:color-mix(in oklab, var(--ok) 12%, transparent)}
  .mark-wrong{outline:2px solid var(--bad); background:color-mix(in oklab, var(--bad) 10%, transparent)}
  .mark-missed{outline:2px dashed var(--warn); background:color-mix(in oklab, var(--warn) 12%, transparent)}
  .hint{margin-top:8px; padding:8px 10px; border-left:4px solid var(--brand); background:color-mix(in oklab, var(--brand) 8%, var(--card)); display:none; border-radius:8px}
  .scorebox{position:sticky; bottom:0; background:var(--card); border-top:1px solid var(--border); padding:10px 14px; display:flex; gap:12px; align-items:center; justify-content:space-between}
  .score{font-weight:800; color:var(--brand)}
  .legend{font-size:13px; display:flex; gap:10px; align-items:center; color:var(--muted)}
  .key{display:inline-block; width:14px; height:14px; border-radius:3px; border:1px solid var(--border); margin-right:4px}
  .k1{background:color-mix(in oklab, var(--ok) 30%, var(--card))}
  .k2{background:color-mix(in oklab, var(--bad) 30%, var(--card))}
  .k3{background:color-mix(in oklab, var(--warn) 40%, var(--card))}
  @media (max-width:640px){ button{flex:1 1 100%; min-width:auto} .options label{padding:12px} }
</style>
</head>
<body>
<header>
  <h1>Ôn tập Giữa kì I - Toán 8</h1>
  <div class="small">Hỗ trợ LaTeX, hình minh họa, gợi ý kiến thức; hai nút làm lại (giữ nguyên / xáo trộn).</div>
</header>

<main>
  <h2>PHẦN TRẮC NGHIỆM</h2>
  <div id="mcqContainer"></div>

  <h2>PHẦN TỰ LUẬN</h2>
  <p class="meta">Kiểu A: chọn 10 ý/5 ý đúng. (Có thể thêm kiểu B: điền đáp án.)</p>
  <div id="multiContainer"></div>
  <div id="shortContainer"></div>

  <div class="actions">
    <button class="primary" onclick="grade()">Chấm điểm</button>
    <button onclick="resetAll(false)">Làm lại (giữ nguyên thứ tự)</button>
    <button onclick="resetAll(true)">Làm lại + Xáo trộn</button>
  </div>

  <div class="scorebox">
    <div class="legend">
      <span class="key k1"></span> Đúng
      <span class="key k2"></span> Sai
      <span class="key k3"></span> Bỏ sót
    </div>
    <div class="score" id="score">Điểm: 0 câu</div>
  </div>
</main>

<script>
/* ===== NẠP DỮ LIỆU TỪ questions.json ===== */
let MCQS=[], MULTI10=[], SHORT=[];
let currentMcqs=[];

fetch('questions.json')
  .then(r => r.json())
  .then(d => {
    MCQS = d.mcqs || [];
    MULTI10 = d.multi10 || [];
    SHORT = d.short || [];
    currentMcqs = JSON.parse(JSON.stringify(MCQS));
    renderMcqs(); renderMulti10(); renderShort();
    if (window.MathJax) MathJax.typesetPromise();
  })
  .catch(err => {
    console.error('Lỗi nạp questions.json:', err);
    alert('Không tải được bộ câu hỏi. Kiểm tra lại questions.json hoặc đường dẫn ảnh.');
  });

/* ===== HÀM TIỆN ÍCH ===== */
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} }
function shuffleOptions(q){
  const pairs = q.options.map((opt,i)=>({opt, idx:i}));
  shuffle(pairs);
  q.options = pairs.map(p=>p.opt);
  q.answer = pairs.findIndex(p=>p.idx===q.answer);
}

/* ===== RENDER ===== */
function renderMcqs(){
  const wrap = document.getElementById('mcqContainer'); wrap.innerHTML='';
  currentMcqs.forEach((q,qi)=>{
    const card = document.createElement('div'); card.className='question'; card.id = `q${qi+1}`;
    const head = document.createElement('div'); head.className='qtitle'; head.innerHTML = `Câu ${qi+1}: ${q.stem}`;
    card.appendChild(head);

    if(q.img){
      const imgWrap=document.createElement('div'); imgWrap.className='qimg';
      const img=document.createElement('img'); img.src=q.img; img.alt='minh họa'; imgWrap.appendChild(img);
      card.appendChild(imgWrap);
    }

    const opts=document.createElement('div'); opts.className='options';
    const name = `q_${q.id || ('i'+qi)}`;
    q.options.forEach((text,oi)=>{
      const lab=document.createElement('label'); const inp=document.createElement('input');
      inp.type='radio'; inp.name=name; inp.dataset.correct=(oi===q.answer);
      lab.appendChild(inp); const span=document.createElement('span'); span.innerHTML=' '+ 'ABCD'[oi]+'. '+text; lab.appendChild(span);
      opts.appendChild(lab);
    });

    const res=document.createElement('div'); res.className='result';
    const hint=document.createElement('div'); hint.className='hint'; hint.innerHTML=q.hint || '';
    const hintBtn=document.createElement('button'); hintBtn.className='hint-btn'; hintBtn.textContent='Gợi ý';
    hintBtn.onclick=()=>{ hint.style.display = hint.style.display==='block' ? 'none' : 'block'; if(window.MathJax) MathJax.typesetPromise(); };

    card.appendChild(opts); card.appendChild(res); card.appendChild(hintBtn); card.appendChild(hint);
    wrap.appendChild(card);
  });
  if(window.MathJax) MathJax.typesetPromise();
}

function renderMulti10(){
  const wrap=document.getElementById('multiContainer'); wrap.innerHTML='';
  MULTI10.forEach((q,qi)=>{
    const card=document.createElement('div'); card.className='question'; card.id=`m${qi+1}`;
    const head=document.createElement('div'); head.className='qtitle'; head.innerHTML=`Câu ${qi+1}A: ${q.title}`; card.appendChild(head);

    if(q.img){
      const iw=document.createElement('div'); iw.className='qimg';
      const im=document.createElement('img'); im.src=q.img; im.alt='minh họa'; iw.appendChild(im); card.appendChild(iw);
    }

    const opts=document.createElement('div'); opts.className='options';
    (q.items||[]).forEach(([text,ok])=>{
      const lab=document.createElement('label'); const inp=document.createElement('input'); inp.type='checkbox'; inp.dataset.correct=!!ok;
      lab.appendChild(inp); const span=document.createElement('span'); span.innerHTML=' '+text; lab.appendChild(span); opts.appendChild(lab);
    });

    const res=document.createElement('div'); res.className='result';
    const hint=document.createElement('div'); hint.className='hint'; hint.innerHTML=q.hint||'';
    const btn=document.createElement('button'); btn.className='hint-btn'; btn.textContent='Gợi ý';
    btn.onclick=()=>{ hint.style.display=hint.style.display==='block'?'none':'block'; if(window.MathJax) MathJax.typesetPromise(); };

    card.appendChild(opts); card.appendChild(res); card.appendChild(btn); card.appendChild(hint);
    wrap.appendChild(card);
  });
  if(window.MathJax) MathJax.typesetPromise();
}

function renderShort(){
  const wrap=document.getElementById('shortContainer'); wrap.innerHTML='';
  (SHORT||[]).forEach((q,qi)=>{
    const card=document.createElement('div'); card.className='question'; card.id=`s${qi+1}`;
    const head=document.createElement('div'); head.className='qtitle'; head.innerHTML=`Câu ${qi+1}B: ${q.title}`; card.appendChild(head);
    const input=document.createElement('input'); input.type='text'; input.style.width='100%'; input.style.padding='10px'; input.placeholder='Nhập đáp án...'; input.dataset.index=qi;
    const tip=document.createElement('p'); tip.className='meta'; tip.textContent='Gợi ý nhập: dùng \"/\" cho phân số, \"^\" cho lũy thừa. Ví dụ: (x+y)^2/2x.';
    const res=document.createElement('div'); res.className='result';
    const hint=document.createElement('div'); hint.className='hint'; hint.innerHTML=q.hint||'';
    const btn=document.createElement('button'); btn.className='hint-btn'; btn.textContent='Gợi ý';
    btn.onclick=()=>{ hint.style.display=hint.style.display==='block'?'none':'block'; if(window.MathJax) MathJax.typesetPromise(); };
    card.appendChild(input); card.appendChild(tip); card.appendChild(res); card.appendChild(btn); card.appendChild(hint);
    wrap.appendChild(card);
  });
  if(window.MathJax) MathJax.typesetPromise();
}

/* ===== CHẤM ĐIỂM ===== */
function normalizeExpr(s){ return (s||'').replace(/\s+/g,'').replace(/·/g,'*').replace(/,/g,'.').toLowerCase(); }

function grade(){
  let total=0, correct=0;

  // MCQ
  currentMcqs.forEach((q,idx)=>{
    total++;
    const card=document.getElementById('q'+(idx+1));
    const chosen=card.querySelector('input[type=radio]:checked');
    const res=card.querySelector('.result'); res.style.display='block';
    card.querySelectorAll('label').forEach(l=>l.classList.remove('mark-correct','mark-wrong','mark-missed'));
    card.querySelectorAll('input[type=radio]').forEach(inp=>{ if(inp.dataset.correct==='true'){ inp.parentElement.classList.add('mark-correct'); }});
    if(chosen && chosen.dataset.correct==='true'){ correct++; res.className='result correct'; res.textContent='Chính xác!'; }
    else if(chosen){ chosen.parentElement.classList.add('mark-wrong'); res.className='result incorrect'; res.textContent='Chưa đúng. Đáp án đúng viền xanh.'; }
    else{ res.className='result incorrect'; res.textContent='Chưa chọn đáp án.'; }
  });

  // Multi10
  MULTI10.forEach((q,idx)=>{
    total++;
    const card=document.getElementById('m'+(idx+1)); const res=card.querySelector('.result'); res.style.display='block';
    let ok=true,picked=false;
    card.querySelectorAll('input[type=checkbox]').forEach(box=>{
      const should=box.dataset.correct==='true'; const lab=box.parentElement;
      lab.classList.remove('mark-correct','mark-wrong','mark-missed');
      if(box.checked) picked=true;
      if(box.checked && should){ lab.classList.add('mark-correct'); }
      else if(box.checked && !should){ lab.classList.add('mark-wrong'); ok=false; }
      else if(!box.checked && should){ lab.classList.add('mark-missed'); ok=false; }
    });
    if(ok && picked){ correct++; res.className='result correct'; res.textContent='Đủ và đúng 5 ý.'; }
    else{ res.className='result incorrect'; res.textContent='Cần chọn đúng 5 ý. Xanh: đúng; Đỏ: sai; Vàng: bỏ sót.'; }
  });

  // Short (nếu có)
  (SHORT||[]).forEach((q,idx)=>{
    total++;
    const card=document.getElementById('s'+(idx+1)); const res=card.querySelector('.result'); res.style.display='block';
    const val=card.querySelector('input').value.trim();
    if(val===''){ res.className='result incorrect'; res.textContent='Chưa nhập đáp án.'; return; }
    let ok=false;
    if(q.expected!==undefined){ ok = normalizeExpr(val)===normalizeExpr(q.expected); }
    else if(q.expectedNumber!==undefined){
      const num = parseFloat(val.replace(',','.')); const tol = q.tol??0;
      ok = !isNaN(num) && Math.abs(num - q.expectedNumber) <= tol;
    }
    if(ok){ correct++; res.className='result correct'; res.textContent='Đúng!'; }
    else{ res.className='result incorrect'; res.textContent='Chưa đúng. Bấm “Gợi ý” để xem hướng dẫn.'; }
  });

  document.getElementById('score').textContent = `Điểm: ${correct}/${total} câu`;
  window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'});
}

/* ===== RESET ===== */
function clearMarks(){
  document.querySelectorAll('label').forEach(l=>l.classList.remove('mark-correct','mark-wrong','mark-missed'));
  document.querySelectorAll('.result').forEach(r=>{ r.style.display='none'; r.textContent=''; r.className='result'; });
  document.querySelectorAll('.hint').forEach(h=>h.style.display='none');
  document.getElementById('score').textContent = 'Điểm: 0 câu';
}
function resetAll(shuffleAll){
  document.querySelectorAll('input[type=radio],input[type=checkbox]').forEach(i=>i.checked=false);
  document.querySelectorAll('#shortContainer input[type=text]').forEach(i=>i.value='');
  clearMarks();
  if(shuffleAll){
    currentMcqs = JSON.parse(JSON.stringify(MCQS));
    shuffle(currentMcqs); currentMcqs.forEach(shuffleOptions);
  }else{
    currentMcqs = JSON.parse(JSON.stringify(MCQS));
  }
  renderMcqs(); renderMulti10(); renderShort();
  window.scrollTo({top:0, behavior:'smooth'});
}
</script>
</body>
</html>
